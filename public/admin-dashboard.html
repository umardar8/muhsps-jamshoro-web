<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | MUHSPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/logo2.png" type="image/png">
    <style>
        :root {
            --brand-dark-blue: #002a80;
            --brand-blue: #0044cc;
            --brand-red: #e63946;
            --brand-green: #2a9d8f;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f9;
        }

        /* Sidebar */
        .dashboard-sidebar {
            background-color: var(--brand-dark-blue);
            min-height: 100vh;
            color: white;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            overflow-y: auto;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.7);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left: 4px solid var(--brand-red);
        }

        .nav-link i {
            width: 25px;
            text-align: center;
            margin-right: 10px;
        }

        /* Main Content Area */
        main {
            margin-left: 16.66667%;
            /* Offset for col-md-2 sidebar */
        }

        @media (max-width: 768px) {
            .dashboard-sidebar {
                position: relative;
                min-height: auto;
            }

            main {
                margin-left: 0;
            }
        }

        /* Stats Cards */
        .stat-card {
            border: none;
            border-radius: 12px;
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .icon-box {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Class Cards */
        .class-card {
            border: none;
            border-top: 4px solid var(--brand-blue);
            border-radius: 10px;
            transition: 0.3s;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        /* Table Styling */
        .table-card {
            border-radius: 12px;
            overflow: hidden;
            border: none;
        }

        .table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        /* View Control */
        .view-section {
            display: none;
            animation: fadeIn 0.4s;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <div class="row">

            <nav class="col-md-3 col-lg-2 d-md-block dashboard-sidebar collapse show">
                <div class="pt-4 px-3">
                    <div class="text-center mb-5">
                        <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                            style="width: 60px; height: 60px;">
                            <i class="fas fa-graduation-cap fa-2x" style="color: var(--brand-dark-blue);"></i>
                        </div>
                        <h6 class="fw-bold mb-0">MUHSPS Admin</h6>
                        <small class="text-white-50">Administrator Panel</small>
                    </div>

                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" onclick="switchView('dashboard', this)">
                                <i class="fas fa-chart-pie"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="switchView('classes', this)">
                                <i class="fas fa-layer-group"></i> Classes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="switchView('teachers', this)">
                                <i class="fas fa-chalkboard-teacher"></i> Teachers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="switchView('website', this)">
                                <i class="fas fa-globe"></i> Website
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" onclick="switchView('settings', this)">
                                <i class="fas fa-cog"></i> Settings
                            </a>
                        </li>
                        <li class="nav-item mt-5">
                            <a class="nav-link text-danger bg-white bg-opacity-10" href="login.html">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">

                <div id="view-dashboard" class="view-section active">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                        <h1 class="h3 fw-bold text-dark">Dashboard Overview</h1>
                        <button class="btn btn-sm btn-outline-secondary" onclick="loadStudents()"><i
                                class="fas fa-sync-alt me-2"></i>Refresh</button>
                    </div>

                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card shadow-sm h-100 border-start border-primary border-4">
                                <div class="card-body d-flex align-items-center">
                                    <div class="icon-box bg-primary bg-opacity-10 text-primary me-3"><i
                                            class="fas fa-users"></i></div>
                                    <div>
                                        <h6 class="text-muted mb-0 small fw-bold">Total Students</h6>
                                        <h3 class="fw-bold mb-0" id="stat-total-students">2418</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card shadow-sm h-100 border-start border-warning border-4">
                                <div class="card-body d-flex align-items-center">
                                    <div class="icon-box bg-warning bg-opacity-10 text-warning me-3"><i
                                            class="fas fa-chalkboard-teacher"></i></div>
                                    <div>
                                        <h6 class="text-muted mb-0 small fw-bold">Total Teachers</h6>
                                        <h3 class="fw-bold mb-0">18</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card shadow-sm h-100 border-start border-danger border-4">
                                <div class="card-body d-flex align-items-center">
                                    <div class="icon-box bg-danger bg-opacity-10 text-danger me-3"><i
                                            class="fas fa-user-plus"></i></div>
                                    <div>
                                        <h6 class="text-muted mb-0 small fw-bold">New Admissions</h6>
                                        <h3 class="fw-bold mb-0" id="stat-new-admissions">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card shadow-sm h-100 border-start border-success border-4">
                                <div class="card-body d-flex align-items-center">
                                    <div class="icon-box bg-success bg-opacity-10 text-success me-3"><i
                                            class="fas fa-money-bill-wave"></i></div>
                                    <div>
                                        <h6 class="text-muted mb-0 small fw-bold">Fee Paid</h6>
                                        <h3 class="fw-bold mb-0" id="stat-fee-paid">0</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card table-card shadow-sm mb-5">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0 text-primary">Active Applications</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th class="ps-4">Student Name</th>
                                        <th>Father Name</th>
                                        <th>Class</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card table-card shadow-sm">
                        <div class="card-header bg-danger text-white py-3">
                            <h5 class="fw-bold mb-0"><i class="fas fa-ban me-2"></i>Rejected Applications</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">Student Name</th>
                                        <th>Class</th>
                                        <th>Rejection Reason</th>
                                        <th>Date</th>
                                        <th class="text-end pe-4">Delete</th>
                                    </tr>
                                </thead>
                                <tbody id="rejectedTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-classes" class="view-section">
                    <h2 class="fw-bold mb-4 border-bottom pb-2">Manage Classes</h2>
                    <div class="row g-4" id="classesGrid">
                    </div>
                </div>

                <div id="view-teachers" class="view-section">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                        <h2 class="fw-bold mb-0">Faculty Directory</h2>
                        <button class="btn btn-primary rounded-pill"><i class="fas fa-plus me-2"></i>Add
                            Teacher</button>
                    </div>
                    <div class="card border-0 shadow-sm rounded-4">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4 py-3">Teacher Name</th>
                                        <th>Subject Specialty</th>
                                        <th>Assigned Classes</th>
                                        <th class="text-end pe-4">Profile</th>
                                    </tr>
                                </thead>
                                <tbody id="teachersTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-website" class="view-section">
                    <h2 class="fw-bold mb-4 border-bottom pb-2">Website Customization</h2>
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card border-0 shadow-sm p-4 mb-4">
                                <h5 class="fw-bold text-primary mb-3">Principal's Message Section</h5>
                                <form>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Principal's Name</label>
                                        <input type="text" class="form-control" value="Prof. Muhammad Jurial Sangi">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Principal's Photo</label>
                                        <div class="d-flex align-items-center gap-3">
                                            <img src="images/principle.png" class="rounded-circle" width="60"
                                                height="60">
                                            <input type="file" class="form-control">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Message Content</label>
                                        <textarea class="form-control"
                                            rows="5">Education is not the learning of facts, but the training of the mind to think...</textarea>
                                    </div>
                                    <button type="button" class="btn btn-success px-4">Save Changes</button>
                                </form>
                            </div>

                            <div class="card border-0 shadow-sm p-4">
                                <h5 class="fw-bold text-primary mb-3">News & Announcements Ticker</h5>
                                <div class="mb-3">
                                    <label class="form-label">Latest News</label>
                                    <input type="text" class="form-control" value="Admissions Open for Session 2026-27">
                                </div>
                                <button type="button" class="btn btn-primary px-4">Update Ticker</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-settings" class="view-section">
                    <h2 class="fw-bold mb-4 border-bottom pb-2">Account Settings</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm p-4">
                                <h5 class="fw-bold mb-4"><i class="fas fa-lock me-2"></i>Change Password</h5>
                                <form>
                                    <div class="mb-3">
                                        <label class="form-label">Current Password</label>
                                        <input type="password" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">New Password</label>
                                        <input type="password" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control">
                                    </div>
                                    <button class="btn btn-brand-blue w-100">Update Password</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <div class="modal fade" id="docsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Student Documents</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex align-items-center mb-4 p-3 bg-light rounded border">
                    <img id="modalStudentPhoto" src="" class="rounded-circle border border-3 border-white shadow me-3" width="70" height="70" style="object-fit: cover;">
                    <div>
                        <h4 class="mb-0 fw-bold" id="modalStudentName">Student Name</h4>
                        <span class="badge bg-secondary">Applicant</span>
                    </div>
                </div>
                <div class="list-group shadow-sm">
                    <a href="#" target="_blank" id="link-form" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <span><i class="fas fa-file-alt text-primary me-3 fa-lg"></i> Filled Admission Form</span><i class="fas fa-external-link-alt text-muted"></i>
                    </a>
                    <a href="#" target="_blank" id="link-cnicF" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <span><i class="fas fa-id-card text-success me-3 fa-lg"></i> Father's CNIC (Front)</span><i class="fas fa-external-link-alt text-muted"></i>
                    </a>
                    <a href="#" target="_blank" id="link-cnicB" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <span><i class="fas fa-id-card text-success me-3 fa-lg"></i> Father's CNIC (Back)</span><i class="fas fa-external-link-alt text-muted"></i>
                    </a>
                    <a href="#" target="_blank" id="link-domicile" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <span><i class="fas fa-map-marked-alt text-warning me-3 fa-lg"></i> Domicile</span><i class="fas fa-external-link-alt text-muted"></i>
                    </a>
                    <a href="#" target="_blank" id="link-prc" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <span><i class="fas fa-stamp text-info me-3 fa-lg"></i> PRC</span><i class="fas fa-external-link-alt text-muted"></i>
                    </a>
                    <a href="#" target="_blank" id="link-leaving" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                        <span><i class="fas fa-university text-danger me-3 fa-lg"></i> School Leaving Certificate</span><i class="fas fa-external-link-alt text-muted"></i>
                    </a>
                </div>
                <div id="paidChallanSection" style="display:none;" class="mt-4">
                    <h6 class="text-uppercase text-success fw-bold small mb-2">Financial Documents</h6>
                    <div class="list-group shadow-sm">
                        <a href="#" target="_blank" id="link-paidChallan" class="list-group-item list-group-item-action list-group-item-success d-flex justify-content-between align-items-center py-3 border-success">
                            <span><i class="fas fa-money-check-alt text-success me-3 fa-lg"></i> <strong>Paid Admission Fee Challan</strong></span>
                            <span class="badge bg-success rounded-pill">Paid</span>
                        </a>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="verifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-check-circle me-2"></i>Verify Application</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-3">You are verifying: <strong id="verifyStudentName" class="text-primary fs-5"></strong></p>
                <div class="alert alert-info border-info small">
                    <i class="fas fa-info-circle me-1"></i> This action will mark the documents as valid. Please upload the Fee Challan to proceed.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Upload Fee Challan PDF</label>
                    <input type="file" id="challanFile" class="form-control" accept=".pdf">
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success px-4 fw-bold" onclick="submitVerification()">Send Challan & Verify</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="objectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Raise Objection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-3">Applicant: <strong id="objectStudentName" class="fs-5"></strong></p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Reason for Objection</label>
                    <textarea id="objectReason" class="form-control" rows="4" placeholder="e.g., CNIC image is blurry, Domicile missing..."></textarea>
                    <div class="form-text text-muted">This message will be shown on the student's dashboard.</div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning px-4 fw-bold" onclick="submitObjection()">Submit Objection</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-ban me-2"></i>Reject Application</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="mb-3">Applicant: <strong id="rejectStudentName" class="fs-5"></strong></p>
                <div class="alert alert-danger border-danger small bg-danger bg-opacity-10 text-danger">
                    <i class="fas fa-exclamation-circle me-1"></i> <strong>Warning:</strong> This action cannot be undone.
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Reason for Rejection</label>
                    <textarea id="rejectReason" class="form-control" rows="4" placeholder="e.g., Not eligible due to age limit..."></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger px-4 fw-bold" onclick="submitRejection()">Confirm Rejection</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-user-check me-2"></i>Confirm Admission</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-check fa-2x"></i>
                    </div>
                    <h5 class="mt-3 fw-bold">Fee Payment Verified</h5>
                </div>
                <p>Student: <strong id="confirmStudentName" class="text-primary"></strong></p>
                <div class="mb-3">
                    <label class="form-label fw-bold">Assign GR Number (Roll No)</label>
                    <input type="text" id="grNumberInput" class="form-control form-control-lg" placeholder="e.g., 2026-CS-01">
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success px-4 fw-bold" onclick="submitConfirmation()">Finalize Admission</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="teacherModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Teacher Profile</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 100px; height: 100px; font-size: 2.5rem; color: #555;">
                    <i class="fas fa-user-tie"></i>
                </div>
                <h3 class="fw-bold mb-1" id="modalTeacherName">Name</h3>
                <p class="text-primary fw-bold mb-3" id="modalTeacherSubject">Subject</p>
                <hr>
                <div class="text-start">
                    <p><strong>Employee ID:</strong> <span class="text-muted">EMP-2024-056</span></p>
                    <p><strong>Teaching Classes:</strong> <span id="modalTeacherClasses" class="badge bg-secondary"></span></p>
                    <p><strong>Experience:</strong> <span class="text-muted">8 Years</span></p>
                    <p><strong>Contact:</strong> <span class="text-muted">+92 300 1234567</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ==========================================
    // 1. GLOBAL VARIABLES
    // ==========================================
    let studentsData = [];
    let currentId = null;
    
    // Define Modal instances globally
    let docsModal, verifyModal, confirmModal, objectModal, rejectModal, teacherModal;

    // ==========================================
    // 2. INITIALIZATION (On Page Load)
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap Modals
        // We use a safe check so it doesn't crash if HTML is missing
        const safeModal = (id) => document.getElementById(id) ? new bootstrap.Modal(document.getElementById(id)) : null;

        docsModal = safeModal('docsModal');
        verifyModal = safeModal('verifyModal');
        confirmModal = safeModal('confirmModal');
        objectModal = safeModal('objectModal');
        rejectModal = safeModal('rejectModal');
        teacherModal = safeModal('teacherModal');
        
        // Load Initial Data
        loadStudents();
    });

    // ==========================================
    // 3. NAVIGATION & UI LOGIC
    // ==========================================
    function switchView(viewName, navElement) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(`view-${viewName}`);
        if(target) target.classList.add('active');
        
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        if(navElement) navElement.classList.add('active');
    }

    // ==========================================
    // 4. DATA LOADING (The List Generator)
    // ==========================================
    async function loadStudents() {
        try {
            console.log("Fetching data...");
            const res = await fetch('/api/admin/students');
            if (!res.ok) throw new Error("Failed to fetch");
            studentsData = await res.json();

            const activeTbody = document.getElementById('studentTableBody');
            const rejectedTbody = document.getElementById('rejectedTableBody');
            
            if(activeTbody) activeTbody.innerHTML = '';
            if(rejectedTbody) rejectedTbody.innerHTML = '';

            const HARDCODED_STUDENTS = 2418;
            let confirmedCount = 0, pendingCount = 0, feePaidCount = 0, activeCount = 0;

            studentsData.forEach(s => {
                if(s.status === 'Confirmed') confirmedCount++;
                if(s.status === 'Pending') pendingCount++;
                if(s.status === 'FeePaid') feePaidCount++;
                if(s.status !== 'Confirmed' && s.status !== 'Rejected') activeCount++;

                // --- A. REJECTED ROW ---
                if (s.status === 'Rejected' && rejectedTbody) {
                    rejectedTbody.innerHTML += `
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold">${s.fullName}</div>
                                <div class="small text-muted">${s.email}</div>
                            </td>
                            <td>${s.classApplying}</td>
                            <td><span class="text-danger small fw-bold">${s.rejectionReason || '-'}</span></td>
                            <td>${s.dob || '-'}</td> 
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${s._id}')" title="Delete Permanently">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>`;
                    return; 
                }

                // --- B. ACTIVE ROW ---
                if (activeTbody) {
                    let badgeClass = 'bg-secondary';
                    if(s.status === 'Pending') badgeClass = 'bg-warning text-dark';
                    else if(s.status === 'Verified') badgeClass = 'bg-info text-dark';
                    else if(s.status === 'FeePaid') badgeClass = 'bg-primary';
                    else if(s.status === 'Confirmed') badgeClass = 'bg-success';
                    else if(s.status === 'Objected') badgeClass = 'bg-danger';

                    let actions = '';

                    // BUTTONS LOGIC
                    if(s.status === 'Pending' || s.status === 'Objected') {
                        actions = `
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewDocuments('${s._id}')" title="View Documents">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="openVerifyModal('${s._id}', '${s.fullName}')" title="Verify Application">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="openObjectModal('${s._id}', '${s.fullName}')" title="Raise Objection">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="openRejectModal('${s._id}', '${s.fullName}')" title="Reject Application">
                                    <i class="fas fa-ban"></i>
                                </button>
                            </div>`;
                    } 
                    else if (s.status === 'Verified') {
                        actions = `<span class="text-muted small fst-italic">Waiting Payment...</span>`;
                    } 
                    else if (s.status === 'FeePaid') {
                        actions = `
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewDocuments('${s._id}')" title="View Docs & Receipt">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="openConfirmModal('${s._id}', '${s.fullName}')" title="Confirm Admission">
                                    <i class="fas fa-check-double"></i>
                                </button>
                            </div>`;
                    } 
                    else if (s.status === 'Confirmed') {
                        actions = `<span class="fw-bold text-success">GR: ${s.grNumber}</span>`;
                    }

                    activeTbody.innerHTML += `
                        <tr>
                            <td class="ps-4 fw-bold">${s.fullName}</td>
                            <td>${s.fatherName || '-'}</td>
                            <td><span class="badge bg-light text-dark border">${s.classApplying}</span></td>
                            <td><span class="badge ${badgeClass} rounded-pill px-3">${s.status}</span></td>
                            <td class="text-start pe-4">${actions}</td>
                        </tr>`;
                }
            });

            // Update Stats
            if(document.getElementById('stat-total-students')) 
                document.getElementById('stat-total-students').innerText = HARDCODED_STUDENTS + confirmedCount;
            if(document.getElementById('stat-new-admissions')) 
                document.getElementById('stat-new-admissions').innerText = pendingCount;
            if(document.getElementById('stat-fee-paid')) 
                document.getElementById('stat-fee-paid').innerText = activeCount === 0 ? "N/A" : feePaidCount;

        } catch (err) { console.error("Load Error:", err); }
    }

    // ==========================================
    // 5. MODAL OPENING FUNCTIONS (Global Scope)
    // ==========================================
    
    function viewDocuments(id) {
        if(!docsModal) return alert("Docs Modal not found in HTML");
        const student = studentsData.find(s => s._id === id);
        if(!student) return;

        document.getElementById('modalStudentName').innerText = student.fullName;
        
        // Handle Photo
        const photoPath = (student.docs && student.docs.studentPhoto) ? '/' + student.docs.studentPhoto : 'https://via.placeholder.com/80';
        document.getElementById('modalStudentPhoto').src = photoPath;

        // Helper to set links
        const setLink = (elId, path) => {
            const el = document.getElementById(elId);
            if(!el) return;
            if(path) {
                el.href = '/' + path;
                el.classList.remove('disabled', 'list-group-item-light');
                el.classList.add('list-group-item-action', 'text-primary');
            } else {
                el.href = '#';
                el.classList.add('disabled', 'list-group-item-light');
                el.classList.remove('list-group-item-action', 'text-primary');
            }
        };

        if(student.docs) {
            setLink('link-form', student.docs.admissionForm);
            setLink('link-cnicF', student.docs.cnicFront);
            setLink('link-cnicB', student.docs.cnicBack);
            setLink('link-domicile', student.docs.domicileDoc);
            setLink('link-prc', student.docs.prcDoc);
            setLink('link-leaving', student.docs.leavingCert);
        }

        // Handle Paid Challan
        const challanSection = document.getElementById('paidChallanSection');
        if(student.paidChallanPath) {
            if(challanSection) challanSection.style.display = 'block';
            setLink('link-paidChallan', student.paidChallanPath);
        } else {
            if(challanSection) challanSection.style.display = 'none';
        }

        docsModal.show();
    }

    function openVerifyModal(id, name) {
        currentId = id;
        document.getElementById('verifyStudentName').innerText = name;
        if(verifyModal) verifyModal.show();
    }

    function openConfirmModal(id, name) {
        currentId = id;
        document.getElementById('confirmStudentName').innerText = name;
        if(confirmModal) confirmModal.show();
    }

    function openObjectModal(id, name) {
        currentId = id;
        document.getElementById('objectStudentName').innerText = name;
        if(objectModal) objectModal.show();
    }

    function openRejectModal(id, name) {
        currentId = id;
        document.getElementById('rejectStudentName').innerText = name;
        if(rejectModal) rejectModal.show();
    }

    // ==========================================
    // 6. ACTION SUBMISSIONS
    // ==========================================

    async function submitVerification() {
        const file = document.getElementById('challanFile').files[0];
        if(!file) return alert("Please upload the Fee Challan PDF.");

        const formData = new FormData();
        formData.append('studentId', currentId);
        formData.append('feeChallan', file);

        try {
            const res = await fetch('/api/admin/verify', { method: 'POST', body: formData });
            if(res.ok) {
                verifyModal.hide();
                loadStudents();
            } else { alert("Failed to verify"); }
        } catch(e) { console.error(e); }
    }

    async function submitConfirmation() {
        const gr = document.getElementById('grNumberInput').value;
        if(!gr) return alert("Please enter GR Number");

        await fetch('/api/admin/confirm', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId: currentId, grNumber: gr }) 
        });
        confirmModal.hide();
        loadStudents();
    }

    async function submitObjection() {
        const reason = document.getElementById('objectReason').value;
        if(!reason) return alert("Please enter a reason");

        await fetch('/api/admin/object', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId: currentId, reason }) 
        });
        objectModal.hide();
        loadStudents();
    }

    async function submitRejection() {
        const reason = document.getElementById('rejectReason').value;
        if(!reason) return alert("Please enter a reason");

        await fetch('/api/admin/reject', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ studentId: currentId, reason }) 
        });
        rejectModal.hide();
        loadStudents();
    }

    async function deleteStudent(id) {
        if(!confirm("Are you sure you want to permanently delete this application?")) return;
        await fetch(`/api/admin/student/${id}`, { method: 'DELETE' });
        loadStudents();
    }

    // ==========================================
    // 7. STATIC DATA (Classes/Teachers View)
    // ==========================================
    // (Kept compact for brevity, this runs on page load)
    const classes = ["Day Care", "Nursery", "KG", "Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6", "Class 7", "Class 8", "Class 9", "Class 10", "Class 11", "Class 12"];
    const incharges = ["Ms. Sadia", "Ms. Hina", "Ms. Fatima", "Mr. Ahmed", "Mr. Bilal", "Ms. Zainab", "Prof. Ali Raza Khoso"];
    const classesGrid = document.getElementById('classesGrid');
    if(classesGrid) {
        classesGrid.innerHTML = '';
        classes.forEach((cls, index) => {
            const count = Math.floor(Math.random() * 30) + 25;
            classesGrid.innerHTML += `<div class="col-md-4 col-lg-3"><div class="card class-card h-100 shadow-sm bg-white p-3"><div class="d-flex justify-content-between align-items-start mb-3"><span class="badge bg-success bg-opacity-10 text-success">${count} Students</span></div><h5 class="fw-bold mb-1">${cls}</h5><p class="text-muted small mb-0"><i class="fas fa-user-check me-1"></i> ${incharges[index % incharges.length]}</p></div></div>`;
        });
    }

    const specificTeachers = [{ name: "Prof. Ali Raza Khoso", subject: "Civil Engineering / Physics", classes: "Class 11, 12" }, { name: "Ms. Nusrat", subject: "Mathematics", classes: "Class 8, 9, 10" }, { name: "Ms. Shabana", subject: "Urdu / Islamiat", classes: "Class 5, 6, 7" }];
    const randomNames = ["Mr. Kamran", "Ms. Ayesha", "Mr. Danish", "Ms. Sana", "Mr. Farhan"];
    const subjects = ["English", "Computer Science", "Chemistry", "Biology", "Social Studies"];
    let teachersData = [...specificTeachers];
    randomNames.forEach((name, i) => { teachersData.push({ name: name, subject: subjects[i%subjects.length], classes: `Class ${Math.floor(Math.random()*5)+1}, ${Math.floor(Math.random()*5)+6}` }); });
    const teacherTbody = document.getElementById('teachersTableBody');
    if(teacherTbody) {
        teacherTbody.innerHTML = '';
        teachersData.forEach((t) => { teacherTbody.innerHTML += `<tr><td class="ps-4"><div class="d-flex align-items-center"><div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width:40px; height:40px; color: #555;"><i class="fas fa-user"></i></div><div class="fw-bold">${t.name}</div></div></td><td>${t.subject}</td><td><span class="badge bg-info bg-opacity-10 text-dark border">${t.classes}</span></td><td class="text-end pe-4"><button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="viewTeacher('${t.name}', '${t.subject}', '${t.classes}')">View Profile</button></td></tr>`; });
    }
    
    function viewTeacher(name, subject, classes) {
        document.getElementById('modalTeacherName').innerText = name;
        document.getElementById('modalTeacherSubject').innerText = subject;
        document.getElementById('modalTeacherClasses').innerText = classes;
        if(teacherModal) teacherModal.show();
    }
</script>

</body>

</html>